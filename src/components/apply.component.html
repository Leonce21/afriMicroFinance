<div class="min-h-screen bg-stone-50 py-16">
  <div class="container mx-auto px-4 max-w-4xl">
    
    @if (isSuccess()) {
      <div class="bg-white rounded-[2rem] shadow-2xl p-16 text-center animate-fade-in">
        <div class="w-28 h-28 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-8 animate-bounce">
           <svg class="w-14 h-14 text-[#228B22]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        </div>
        <h2 class="text-4xl font-bold font-serif text-gray-900 mb-6">Application Submitted!</h2>
        <p class="text-gray-600 text-xl mb-10 leading-relaxed max-w-lg mx-auto">
          Thank you, <span class="font-bold text-gray-900">{{personalGroup.get('firstName')?.value}}</span>. We have received your application. A loan officer will review it and contact you within 24 hours.
        </p>
        <a routerLink="/" class="px-12 py-4 bg-[#FF6B00] text-white rounded-xl font-bold hover:bg-[#e65a00] transition-colors shadow-xl hover:shadow-orange-200">Return Home</a>
      </div>
    } @else {
      <!-- Progress Bar -->
      <div class="mb-16">
        <div class="flex justify-between items-center relative z-10 px-8">
          <!-- Step 1 Indicator -->
          <div class="flex flex-col items-center gap-3">
            <div class="w-14 h-14 rounded-2xl flex items-center justify-center border-2 font-bold transition-all duration-500"
                 [ngClass]="currentStep() >= 1 ? (currentStep() > 1 ? 'step-completed' : 'step-active') : 'step-inactive'">
              @if (currentStep() > 1) { 
                <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
              } @else { 
                <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
              }
            </div>
            <span class="text-xs font-bold text-gray-500 uppercase tracking-widest">Personal</span>
          </div>

           <!-- Step 2 Indicator -->
          <div class="flex flex-col items-center gap-3">
            <div class="w-14 h-14 rounded-2xl flex items-center justify-center border-2 font-bold transition-all duration-500"
                 [ngClass]="currentStep() >= 2 ? (currentStep() > 2 ? 'step-completed' : 'step-active') : 'step-inactive'">
               @if (currentStep() > 2) { 
                  <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
               } @else { 
                  <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
               }
            </div>
            <span class="text-xs font-bold text-gray-500 uppercase tracking-widest">Business</span>
          </div>

           <!-- Step 3 Indicator -->
          <div class="flex flex-col items-center gap-3">
            <div class="w-14 h-14 rounded-2xl flex items-center justify-center border-2 font-bold transition-all duration-500"
                 [ngClass]="currentStep() >= 3 ? 'step-active' : 'step-inactive'">
               <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
            </div>
            <span class="text-xs font-bold text-gray-500 uppercase tracking-widest">Documents</span>
          </div>
        </div>
        
        <!-- Connecting Line -->
        <div class="absolute top-[6rem] left-0 w-full h-1 bg-gray-200 -z-0 px-12">
           <div class="h-full bg-[#FF6B00] transition-all duration-700 ease-out" 
                [style.width]="currentStep() === 1 ? '0%' : (currentStep() === 2 ? '50%' : '100%')"></div>
        </div>
      </div>

      <!-- Form Container -->
      <div class="bg-white rounded-[2.5rem] shadow-xl p-8 md:p-14 border border-gray-100 relative overflow-hidden min-h-[500px]">
        <form [formGroup]="applyForm">
          
          <!-- Step 1: Personal -->
          @if (currentStep() === 1) {
            <div class="space-y-8 animate-fade-in" [formGroup]="personalGroup">
              <div class="text-center mb-10">
                <h3 class="text-3xl font-bold font-serif text-gray-900 mb-2">Who are you?</h3>
                <p class="text-gray-500 text-lg">We need a few details to get started.</p>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-2">
                  <label class="block text-sm font-bold text-gray-700 ml-1 uppercase tracking-wide">First Name</label>
                  <input formControlName="firstName" type="text" class="w-full px-6 py-4 rounded-xl border border-gray-200 bg-gray-50 outline-none transition-all placeholder-gray-400" placeholder="e.g. Samuel">
                </div>
                <div class="space-y-2">
                  <label class="block text-sm font-bold text-gray-700 ml-1 uppercase tracking-wide">Last Name</label>
                  <input formControlName="lastName" type="text" class="w-full px-6 py-4 rounded-xl border border-gray-200 bg-gray-50 outline-none transition-all placeholder-gray-400" placeholder="e.g. Mwangi">
                </div>
              </div>
              <div class="space-y-2">
                <label class="block text-sm font-bold text-gray-700 ml-1 uppercase tracking-wide">Phone Number</label>
                <input formControlName="phone" type="tel" class="w-full px-6 py-4 rounded-xl border border-gray-200 bg-gray-50 outline-none transition-all placeholder-gray-400" placeholder="+254...">
              </div>
              <div class="space-y-2">
                <label class="block text-sm font-bold text-gray-700 ml-1 uppercase tracking-wide">Email Address</label>
                <input formControlName="email" type="email" class="w-full px-6 py-4 rounded-xl border border-gray-200 bg-gray-50 outline-none transition-all placeholder-gray-400" placeholder="samuel@example.com">
              </div>
            </div>
          }

          <!-- Step 2: Business -->
          @if (currentStep() === 2) {
            <div class="space-y-8 animate-fade-in" [formGroup]="businessGroup">
              <div class="text-center mb-10">
                 <h3 class="text-3xl font-bold font-serif text-gray-900 mb-2">Tell us about your business</h3>
                 <p class="text-gray-500 text-lg">Help us understand your financial needs.</p>
              </div>

              <div class="space-y-2">
                <label class="block text-sm font-bold text-gray-700 ml-1 uppercase tracking-wide">Business Name</label>
                <input formControlName="businessName" type="text" class="w-full px-6 py-4 rounded-xl border border-gray-200 bg-gray-50 outline-none transition-all">
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-2">
                  <label class="block text-sm font-bold text-gray-700 ml-1 uppercase tracking-wide">Business Type</label>
                  <div class="relative">
                    <select formControlName="type" class="w-full px-6 py-4 rounded-xl border border-gray-200 bg-gray-50 outline-none appearance-none transition-all cursor-pointer">
                      <option value="">Select...</option>
                      <option value="agriculture">Agriculture</option>
                      <option value="retail">Retail/Shop</option>
                      <option value="service">Service</option>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-6 pointer-events-none text-gray-500">
                      <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                    </div>
                  </div>
                </div>
                <div class="space-y-2">
                  <label class="block text-sm font-bold text-gray-700 ml-1 uppercase tracking-wide">Monthly Revenue (Est)</label>
                  <input formControlName="monthlyRevenue" type="number" class="w-full px-6 py-4 rounded-xl border border-gray-200 bg-gray-50 outline-none transition-all" placeholder="$">
                </div>
              </div>
              <div class="space-y-2">
                <label class="block text-sm font-bold text-gray-700 ml-1 uppercase tracking-wide">Loan Amount Needed</label>
                <input formControlName="loanAmount" type="number" class="w-full px-6 py-4 rounded-xl border border-gray-200 bg-gray-50 outline-none transition-all" placeholder="$">
              </div>
            </div>
          }

          <!-- Step 3: Documents -->
          @if (currentStep() === 3) {
            <div class="space-y-8 animate-fade-in" [formGroup]="documentsGroup">
              <div class="text-center mb-10">
                 <h3 class="text-3xl font-bold font-serif text-gray-900 mb-2">Verification</h3>
                 <p class="text-gray-500 text-lg">Securely upload a valid ID card.</p>
              </div>
              
              <div class="border-4 border-dashed border-gray-200 rounded-3xl p-16 text-center hover:border-[#FF6B00] hover:bg-orange-50/30 transition-all duration-300 cursor-pointer group" (click)="mockUpload()">
                @if (!documentsGroup.get('idUploaded')?.value) {
                  <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform duration-300">
                    <svg class="w-10 h-10 text-gray-400 group-hover:text-[#FF6B00]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                  </div>
                  <p class="text-gray-800 font-bold text-xl">Click to upload ID</p>
                  <p class="text-gray-500 mt-2">JPG, PNG up to 5MB</p>
                } @else {
                  <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 animate-bounce-short">
                    <svg class="w-10 h-10 text-green-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>
                  </div>
                  <p class="text-green-600 font-bold text-xl">Document Uploaded Successfully</p>
                }
              </div>
              <input type="checkbox" formControlName="idUploaded" class="hidden">
            </div>
          }

          <!-- Controls -->
          <div class="flex justify-between mt-16 pt-8 border-t border-gray-100">
            <button type="button" 
                    (click)="prevStep()" 
                    [disabled]="currentStep() === 1"
                    class="px-8 py-3 rounded-xl text-gray-500 font-bold hover:bg-gray-100 disabled:opacity-30 disabled:cursor-not-allowed transition-all">
              Back
            </button>
            
            @if (currentStep() < 3) {
              <button type="button" 
                      (click)="nextStep()"
                      class="px-12 py-4 bg-[#FF6B00] text-white rounded-xl font-bold hover:bg-[#e65a00] hover:shadow-xl hover:shadow-orange-200 transition-all flex items-center gap-2 transform hover:-translate-y-1">
                Next Step
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
              </button>
            } @else {
              <button type="button" 
                      (click)="submit()"
                      [disabled]="!applyForm.valid || isSubmitting()"
                      class="px-12 py-4 bg-[#228B22] text-white rounded-xl font-bold hover:bg-green-700 hover:shadow-xl hover:shadow-green-200 transition-all disabled:opacity-70 disabled:cursor-not-allowed flex items-center gap-3 transform hover:-translate-y-1">
                @if (isSubmitting()) {
                  <svg class="animate-spin h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  Processing...
                } @else {
                  Submit Application
                }
              </button>
            }
          </div>
        </form>
      </div>
    }
  </div>
</div>